<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Content Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Admin Panel</h1>
            <a href="login.html" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                Logout
            </a>
        </div>


        <!-- General Images Management -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage General Images</h2>
            <div id="images-container" class="space-y-8">
                <!-- General images sections will be dynamically added here -->
            </div>
            <button id="add-image-btn" class="mt-6 bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600">Add New Image</button>
        </div>

        <!-- Room Types Management -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage Room Types</h2>
            <div id="room-types-container" class="space-y-8">
                <!-- Room types sections will be dynamically added here -->
            </div>
            <button id="add-room-type-btn" class="mt-6 bg-indigo-500 text-white px-6 py-2 rounded-md hover:bg-indigo-600">Add New Room Type</button>
        </div>

        <!-- Rooms Management -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage Rooms</h2>
            <div id="rooms-container" class="space-y-8">
                <!-- Rooms sections will be dynamically added here -->
            </div>
            <button id="add-room-btn" class="mt-6 bg-teal-500 text-white px-6 py-2 rounded-md hover:bg-teal-600">Add New Room</button>
        </div>

        <!-- Accommodation Management -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage Accommodations</h2>
            <div id="accommodation-container" class="space-y-8">
                <!-- Accommodation sections will be dynamically added here -->
            </div>
            <button id="add-accommodation-btn" class="mt-6 bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600">Add New Accommodation</button>
        </div>

        <!-- Button Management -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage Buttons</h2>
            <div id="button-container" class="space-y-8">
                <!-- Button sections will be dynamically added here -->
            </div>
        </div>

        <!-- Popup Management -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage Popup</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center mb-4">
                    <label for="popup-enabled" class="font-medium text-gray-700 mr-4">Popup Enabled</label>
                    <input type="checkbox" id="popup-enabled" class="h-6 w-6 rounded text-purple-600 focus:ring-purple-500">
                </div>
                <div>
                    <label for="popup-title" class="block text-sm font-medium text-gray-700 mb-1">Popup Title</label>
                    <input type="text" id="popup-title" class="w-full border rounded-md p-2 mb-4">
                </div>
                <div>
                    <label for="popup-message" class="block text-sm font-medium text-gray-700 mb-1">Popup Message</label>
                    <textarea id="popup-message" class="w-full border rounded-md p-2 h-24"></textarea>
                </div>
                <div>
                    <label for="popup-button-text" class="block text-sm font-medium text-gray-700 mt-4 mb-1">Popup Button Text</label>
                    <input type="text" id="popup-button-text" class="w-full border rounded-md p-2 mb-4">
                </div>
                <div>
                    <label for="popup-button-link" class="block text-sm font-medium text-gray-700 mt-4 mb-1">Popup Button Link</label>
                    <input type="text" id="popup-button-link" class="w-full border rounded-md p-2 mb-4">
                </div>
                 <div>
                    <label for="popup-image" class="block text-sm font-medium text-gray-700 mt-4 mb-1">Popup Image URL</label>
                    <input type="text" id="popup-image" class="w-full border rounded-md p-2 mb-2" onchange="updatePopupImagePreview()">
                    <div id="popup-image-preview" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Parallax Management -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage Parallax Background</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div>
                    <label for="parallax-bg" class="block text-sm font-medium text-gray-700 mb-1">Background Image URL</label>
                    <input type="text" id="parallax-bg" class="w-full border rounded-md p-2 mb-2" onchange="updateParallaxImagePreview()">
                    <div id="parallax-image-preview" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Manage Pages -->
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Manage Pages</h2>
            <div id="page-container" class="space-y-8">
                <!-- Page editor sections will be dynamically added here -->
            </div>
        </div>

        <div class="mt-12 border-t pt-8">
            <button id="save-all-btn" class="bg-purple-600 text-white px-8 py-3 rounded-md hover:bg-purple-700 text-lg font-semibold">Save Global Settings</button>
            <p id="save-message" class="text-sm mt-4"></p>
            <p class="text-xs text-gray-500 mt-2">Note: Individual items are saved automatically when you click their respective "Save Changes" buttons.</p>
        </div>
    </div>
    <!-- Load Database API Client -->
    <script src="database-api.js"></script>
    
    <script>
        // Authentication check
        async function checkAuthentication() {
            try {
                const response = await fetch('/api/auth.php');
                const data = await response.json();
                if (!data.data.loggedIn) {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = 'login.html';
            }
        }

        // Perform authentication check
        checkAuthentication();

        document.addEventListener('DOMContentLoaded', async () => {
            const imagesContainer = document.getElementById('images-container');
            const roomTypesContainer = document.getElementById('room-types-container');
            const roomsContainer = document.getElementById('rooms-container');
            const accommodationContainer = document.getElementById('accommodation-container');
            const buttonContainer = document.getElementById('button-container');
            const saveAllBtn = document.getElementById('save-all-btn');
            const addImageBtn = document.getElementById('add-image-btn');
            const addRoomTypeBtn = document.getElementById('add-room-type-btn');
            const addRoomBtn = document.getElementById('add-room-btn');
            const addAccommodationBtn = document.getElementById('add-accommodation-btn');
            const saveMessage = document.getElementById('save-message');

            // Test database connection on load
            try {
                loading.show('Connecting to database...');
                const healthCheck = await dbAPI.testConnection();
                if (healthCheck.success) {
                    notify.success('Database connected successfully');
                    await loadAllContent();
                } else {
                    notify.error('Database connection failed');
                }
            } catch (error) {
                console.error('Database connection error:', error);
                notify.error('Failed to connect to database: ' + error.message);
            } finally {
                loading.hide();
            }

            async function loadAllContent() {
                try {
                    loading.show('Loading content...');
                    await Promise.all([
                        renderImages(),
                        renderRoomTypes(),
                        renderRooms(),
                        renderAccommodations(),
                        renderButtons(),
                        renderPopup(),
                        renderParallax(),
                        renderPages()
                    ]);
                    notify.success('Content loaded successfully');
                } catch (error) {
                    console.error('Error loading content:', error);
                    notify.error('Failed to load content: ' + error.message);
                } finally {
                    loading.hide();
                }
            }


            async function renderImages() {
                try {
                    const response = await dbAPI.getImages();
                    const images = response.data || [];

                    imagesContainer.innerHTML = '';
                    if (images.length > 0) {
                        images.forEach((img) => {
                            const section = document.createElement('div');
                            section.className = 'bg-white p-6 rounded-lg shadow-md relative';
                            section.innerHTML = `
                                <h3 class="text-xl font-semibold mb-4">Image: ${img.alt || `Image ${img.id}`}</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <label for="img-src-${img.id}" class="block text-sm font-medium text-gray-700 mb-1">Image Source URL</label>
                                        <input type="text" id="img-src-${img.id}" value="${img.src}" class="w-full border rounded-md p-2 mb-4">
                                        <img src="${img.src}" class="max-w-xs rounded-md border" onerror="this.src='https://placehold.co/300x200/E0E0E0/666?text=Image+Not+Found'">
                                    </div>
                                    <div>
                                        <label for="img-type-${img.id}" class="block text-sm font-medium text-gray-700 mb-1">Image Type</label>
                                        <select id="img-type-${img.id}" class="w-full border rounded-md p-2 mb-4">
                                            <option value="hero" ${img.type === 'hero' ? 'selected' : ''}>Hero</option>
                                            <option value="gallery" ${img.type === 'gallery' ? 'selected' : ''}>Gallery</option>
                                            <option value="thumbnail" ${img.type === 'thumbnail' ? 'selected' : ''}>Thumbnail</option>
                                            <option value="parallax" ${img.type === 'parallax' ? 'selected' : ''}>Parallax</option>
                                            <option value="popup" ${img.type === 'popup' ? 'selected' : ''}>Popup</option>
                                        </select>
                                        <label for="img-category-${img.id}" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                        <input type="text" id="img-category-${img.id}" value="${img.category || ''}" class="w-full border rounded-md p-2 mb-4">
                                        <label for="img-alt-${img.id}" class="block text-sm font-medium text-gray-700 mb-1">Alt Text</label>
                                        <input type="text" id="img-alt-${img.id}" value="${img.alt || ''}" class="w-full border rounded-md p-2 mb-4">
                                        <label for="img-description-${img.id}" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <textarea id="img-description-${img.id}" class="w-full border rounded-md p-2 h-20">${img.description || ''}</textarea>
                                    </div>
                                </div>
                                <div class="mt-4 flex gap-2">
                                    <button class="save-image-btn bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" data-id="${img.id}">Save Changes</button>
                                    <button class="delete-image-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" data-id="${img.id}">Delete</button>
                                </div>
                            `;
                            imagesContainer.appendChild(section);
                        });

                        // Add save event listeners
                        document.querySelectorAll('.save-image-btn').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                const imageId = e.target.dataset.id;
                                try {
                                    loading.show('Saving image...');
                                    const imageData = {
                                        src: document.getElementById(`img-src-${imageId}`).value,
                                        alt: document.getElementById(`img-alt-${imageId}`).value,
                                        type: document.getElementById(`img-type-${imageId}`).value,
                                        category: document.getElementById(`img-category-${imageId}`).value,
                                        description: document.getElementById(`img-description-${imageId}`).value
                                    };
                                    
                                    await dbAPI.updateImage(imageId, imageData);
                                    notify.success('Image updated successfully');
                                } catch (error) {
                                    console.error('Error saving image:', error);
                                    notify.error('Failed to save image: ' + error.message);
                                } finally {
                                    loading.hide();
                                }
                            });
                        });

                        // Add delete event listeners
                        document.querySelectorAll('.delete-image-btn').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                const imageId = e.target.dataset.id;
                                if (confirm('Are you sure you want to delete this image?')) {
                                    try {
                                        loading.show('Deleting image...');
                                        await dbAPI.deleteImage(imageId);
                                        notify.success('Image deleted successfully');
                                        await renderImages();
                                    } catch (error) {
                                        console.error('Error deleting image:', error);
                                        notify.error('Failed to delete image: ' + error.message);
                                    } finally {
                                        loading.hide();
                                    }
                                }
                            });
                        });
                    } else {
                        imagesContainer.innerHTML = '<p class="text-gray-500 italic">No images found. Click "Add New Image" to create one.</p>';
                    }
                } catch (error) {
                    console.error('Error loading images:', error);
                    imagesContainer.innerHTML = '<p class="text-red-500">Error loading images. Please try again.</p>';
                }
            }

            async function renderRoomTypes() {
                try {
                    const response = await dbAPI.getRoomTypes();
                    const roomTypes = response.data || [];

                    roomTypesContainer.innerHTML = '';
                    roomTypes.forEach((roomType) => {
                        const section = document.createElement('div');
                        section.className = 'bg-white p-6 rounded-lg shadow-md relative';
                        section.innerHTML = `
                            <h3 class="text-xl font-semibold mb-4">${roomType.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label for="rt-name-${roomType.id}" class="block text-sm font-medium text-gray-700 mb-1">Room Type Name</label>
                                    <input type="text" id="rt-name-${roomType.id}" value="${roomType.name}" class="w-full border rounded-md p-2 mb-4" required>
                                    
                                    <label for="rt-base-price-${roomType.id}" class="block text-sm font-medium text-gray-700 mb-1">Base Price</label>
                                    <input type="number" id="rt-base-price-${roomType.id}" value="${roomType.base_price}" class="w-full border rounded-md p-2 mb-4" step="0.01" required>
                                    
                                    <label for="rt-max-guests-${roomType.id}" class="block text-sm font-medium text-gray-700 mb-1">Max Guests</label>
                                    <input type="number" id="rt-max-guests-${roomType.id}" value="${roomType.max_guests}" class="w-full border rounded-md p-2 mb-4" required>
                                </div>
                                <div>
                                    <label for="rt-description-${roomType.id}" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea id="rt-description-${roomType.id}" class="w-full border rounded-md p-2 h-24 mb-4">${roomType.description || ''}</textarea>
                                    
                                    <label for="rt-size-${roomType.id}" class="block text-sm font-medium text-gray-700 mb-1">Size (sqm)</label>
                                    <input type="number" id="rt-size-${roomType.id}" value="${roomType.size_sqm || ''}" class="w-full border rounded-md p-2 mb-4">
                                    
                                    <label for="rt-sort-order-${roomType.id}" class="block text-sm font-medium text-gray-700 mb-1">Sort Order</label>
                                    <input type="number" id="rt-sort-order-${roomType.id}" value="${roomType.sort_order || 0}" class="w-full border rounded-md p-2 mb-4">
                                    
                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="rt-active-${roomType.id}" ${roomType.is_active ? 'checked' : ''} class="mr-2">
                                            <span class="text-sm text-gray-700">Active</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button class="save-room-type-btn bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600" data-id="${roomType.id}">Save Changes</button>
                                <button class="delete-room-type-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" data-id="${roomType.id}">Delete</button>
                            </div>
                        `;
                        roomTypesContainer.appendChild(section);
                    });

                    addRoomTypeEventListeners();
                } catch (error) {
                    console.error('Error loading room types:', error);
                    roomTypesContainer.innerHTML = '<p class="text-red-500">Error loading room types. Please try again.</p>';
                }
            }

            function addRoomTypeEventListeners() {
                // Add save event listeners
                document.querySelectorAll('.save-room-type-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const roomTypeId = e.target.dataset.id;
                        try {
                            loading.show('Saving room type...');
                            const roomTypeData = {
                                name: document.getElementById(`rt-name-${roomTypeId}`).value,
                                description: document.getElementById(`rt-description-${roomTypeId}`).value,
                                base_price: parseFloat(document.getElementById(`rt-base-price-${roomTypeId}`).value),
                                max_guests: parseInt(document.getElementById(`rt-max-guests-${roomTypeId}`).value),
                                size_sqm: parseInt(document.getElementById(`rt-size-${roomTypeId}`).value) || null,
                                sort_order: parseInt(document.getElementById(`rt-sort-order-${roomTypeId}`).value) || 0,
                                is_active: document.getElementById(`rt-active-${roomTypeId}`).checked
                            };
                            
                            await dbAPI.updateRoomType(roomTypeId, roomTypeData);
                            notify.success('Room type updated successfully');
                        } catch (error) {
                            console.error('Error saving room type:', error);
                            notify.error('Failed to save room type: ' + error.message);
                        } finally {
                            loading.hide();
                        }
                    });
                });

                // Add delete event listeners
                document.querySelectorAll('.delete-room-type-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const roomTypeId = e.target.dataset.id;
                        if (confirm('Are you sure you want to delete this room type? This will also delete all associated rooms.')) {
                            try {
                                loading.show('Deleting room type...');
                                await dbAPI.deleteRoomType(roomTypeId);
                                notify.success('Room type deleted successfully');
                                await renderRoomTypes();
                                await renderRooms(); // Refresh rooms too
                            } catch (error) {
                                console.error('Error deleting room type:', error);
                                notify.error('Failed to delete room type: ' + error.message);
                            } finally {
                                loading.hide();
                            }
                        }
                    });
                });
            }

            async function renderRooms() {
                try {
                    const [roomsResponse, roomTypesResponse] = await Promise.all([
                        dbAPI.getRooms(),
                        dbAPI.getRoomTypes()
                    ]);
                    
                    const rooms = roomsResponse.data || [];
                    const roomTypes = roomTypesResponse.data || [];

                    roomsContainer.innerHTML = '';
                    rooms.forEach((room) => {
                        const section = document.createElement('div');
                        section.className = 'bg-white p-6 rounded-lg shadow-md relative';
                        section.innerHTML = `
                            <h3 class="text-xl font-semibold mb-4">Room ${room.room_number} - ${room.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="room-number-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Room Number</label>
                                    <input type="text" id="room-number-${room.id}" value="${room.room_number}" class="w-full border rounded-md p-2 mb-4" required>
                                    
                                    <label for="room-name-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Room Name</label>
                                    <input type="text" id="room-name-${room.id}" value="${room.name}" class="w-full border rounded-md p-2 mb-4" required>
                                    
                                    <label for="room-type-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Room Type</label>
                                    <select id="room-type-${room.id}" class="w-full border rounded-md p-2 mb-4" required>
                                        ${roomTypes.map(rt => `<option value="${rt.id}" ${rt.id == room.room_type_id ? 'selected' : ''}>${rt.name}</option>`).join('')}
                                    </select>
                                    
                                    <label for="room-price-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Price per Night</label>
                                    <input type="number" id="room-price-${room.id}" value="${room.price_per_night}" class="w-full border rounded-md p-2 mb-4" step="0.01" required>
                                </div>
                                <div>
                                    <label for="room-max-guests-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Max Guests</label>
                                    <input type="number" id="room-max-guests-${room.id}" value="${room.max_guests}" class="w-full border rounded-md p-2 mb-4">
                                    
                                    <div class="grid grid-cols-2 gap-2 mb-4">
                                        <div>
                                            <label for="room-bedrooms-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Bedrooms</label>
                                            <input type="number" id="room-bedrooms-${room.id}" value="${room.bedrooms || 1}" class="w-full border rounded-md p-2">
                                        </div>
                                        <div>
                                            <label for="room-bathrooms-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Bathrooms</label>
                                            <input type="number" id="room-bathrooms-${room.id}" value="${room.bathrooms || 1}" class="w-full border rounded-md p-2">
                                        </div>
                                    </div>
                                    
                                    <label for="room-view-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">View Type</label>
                                    <select id="room-view-${room.id}" class="w-full border rounded-md p-2 mb-4">
                                        <option value="">Select View</option>
                                        <option value="pool" ${room.view_type === 'pool' ? 'selected' : ''}>Pool</option>
                                        <option value="garden" ${room.view_type === 'garden' ? 'selected' : ''}>Garden</option>
                                        <option value="jungle" ${room.view_type === 'jungle' ? 'selected' : ''}>Jungle</option>
                                        <option value="ocean" ${room.view_type === 'ocean' ? 'selected' : ''}>Ocean</option>
                                        <option value="mountain" ${room.view_type === 'mountain' ? 'selected' : ''}>Mountain</option>
                                    </select>
                                    
                                    <label for="room-status-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="room-status-${room.id}" class="w-full border rounded-md p-2 mb-4">
                                        <option value="available" ${room.status === 'available' ? 'selected' : ''}>Available</option>
                                        <option value="occupied" ${room.status === 'occupied' ? 'selected' : ''}>Occupied</option>
                                        <option value="maintenance" ${room.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                        <option value="out_of_order" ${room.status === 'out_of_order' ? 'selected' : ''}>Out of Order</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="room-description-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea id="room-description-${room.id}" class="w-full border rounded-md p-2 h-20 mb-4">${room.description || ''}</textarea>
                                    
                                    <label for="room-bed-type-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Bed Type</label>
                                    <input type="text" id="room-bed-type-${room.id}" value="${room.bed_type || ''}" class="w-full border rounded-md p-2 mb-4" placeholder="e.g. King, Queen, Twin">
                                    
                                    <div class="grid grid-cols-2 gap-2 mb-4">
                                        <div>
                                            <label for="room-floor-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                                            <input type="number" id="room-floor-${room.id}" value="${room.floor || ''}" class="w-full border rounded-md p-2">
                                        </div>
                                        <div>
                                            <label for="room-size-${room.id}" class="block text-sm font-medium text-gray-700 mb-1">Size (sqm)</label>
                                            <input type="number" id="room-size-${room.id}" value="${room.size_sqm || ''}" class="w-full border rounded-md p-2">
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <input type="checkbox" id="room-active-${room.id}" ${room.is_active ? 'checked' : ''} class="mr-2">
                                        <label for="room-active-${room.id}" class="text-sm text-gray-700">Active</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button class="save-room-btn bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600" data-id="${room.id}">Save Changes</button>
                                <button class="manage-amenities-btn bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600" data-id="${room.id}">Manage Amenities</button>
                                <button class="delete-room-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" data-id="${room.id}">Delete</button>
                            </div>
                        `;
                        roomsContainer.appendChild(section);
                    });

                    addRoomEventListeners();
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    roomsContainer.innerHTML = '<p class="text-red-500">Error loading rooms. Please try again.</p>';
                }
            }

            function addRoomEventListeners() {
                // Add save event listeners
                document.querySelectorAll('.save-room-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const roomId = e.target.dataset.id;
                        try {
                            loading.show('Saving room...');
                            const roomData = {
                                room_number: document.getElementById(`room-number-${roomId}`).value,
                                room_type_id: parseInt(document.getElementById(`room-type-${roomId}`).value),
                                name: document.getElementById(`room-name-${roomId}`).value,
                                description: document.getElementById(`room-description-${roomId}`).value,
                                floor: parseInt(document.getElementById(`room-floor-${roomId}`).value) || null,
                                view_type: document.getElementById(`room-view-${roomId}`).value || null,
                                price_per_night: parseFloat(document.getElementById(`room-price-${roomId}`).value),
                                max_guests: parseInt(document.getElementById(`room-max-guests-${roomId}`).value),
                                bedrooms: parseInt(document.getElementById(`room-bedrooms-${roomId}`).value),
                                bathrooms: parseInt(document.getElementById(`room-bathrooms-${roomId}`).value),
                                size_sqm: parseInt(document.getElementById(`room-size-${roomId}`).value) || null,
                                bed_type: document.getElementById(`room-bed-type-${roomId}`).value || null,
                                status: document.getElementById(`room-status-${roomId}`).value,
                                is_active: document.getElementById(`room-active-${roomId}`).checked
                            };
                            
                            await dbAPI.updateRoom(roomId, roomData);
                            notify.success('Room updated successfully');
                        } catch (error) {
                            console.error('Error saving room:', error);
                            notify.error('Failed to save room: ' + error.message);
                        } finally {
                            loading.hide();
                        }
                    });
                });

                // Add delete event listeners
                document.querySelectorAll('.delete-room-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const roomId = e.target.dataset.id;
                        if (confirm('Are you sure you want to delete this room? This will also delete all associated amenities and images.')) {
                            try {
                                loading.show('Deleting room...');
                                await dbAPI.deleteRoom(roomId);
                                notify.success('Room deleted successfully');
                                await renderRooms();
                            } catch (error) {
                                console.error('Error deleting room:', error);
                                notify.error('Failed to delete room: ' + error.message);
                            } finally {
                                loading.hide();
                            }
                        }
                    });
                });

                // Add manage amenities event listeners
                document.querySelectorAll('.manage-amenities-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const roomId = e.target.dataset.id;
                        openAmenitiesModal(roomId);
                    });
                });
            }

            async function openAmenitiesModal(roomId) {
                // Create modal for managing amenities
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                        <h3 class="text-xl font-semibold mb-4">Manage Room Amenities</h3>
                        <div id="amenities-form">
                            <div id="amenities-list" class="space-y-4 mb-4">
                                <!-- Amenities will be loaded here -->
                            </div>
                            <button id="add-amenity-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add Amenity</button>
                        </div>
                        <div class="mt-6 flex justify-end gap-2">
                            <button id="save-amenities-btn" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">Save All</button>
                            <button id="close-modal-btn" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                try {
                    // Load existing amenities
                    const response = await dbAPI.getRoomAmenities(roomId);
                    const amenities = response.data || [];
                    renderAmenitiesForm(amenities);
                } catch (error) {
                    console.error('Error loading amenities:', error);
                    notify.error('Failed to load amenities');
                }

                // Event listeners
                document.getElementById('add-amenity-btn').addEventListener('click', () => {
                    addAmenityRow();
                });

                document.getElementById('save-amenities-btn').addEventListener('click', async () => {
                    await saveAmenities(roomId);
                    modal.remove();
                });

                document.getElementById('close-modal-btn').addEventListener('click', () => {
                    modal.remove();
                });
            }

            function renderAmenitiesForm(amenities) {
                const amenitiesList = document.getElementById('amenities-list');
                amenitiesList.innerHTML = '';

                amenities.forEach((amenity, index) => {
                    addAmenityRow(amenity, index);
                });

                if (amenities.length === 0) {
                    addAmenityRow();
                }
            }

            function addAmenityRow(amenity = null, index = null) {
                const amenitiesList = document.getElementById('amenities-list');
                const newIndex = index !== null ? index : amenitiesList.children.length;
                
                const row = document.createElement('div');
                row.className = 'grid grid-cols-1 md:grid-cols-5 gap-4 p-4 border rounded';
                row.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amenity Name</label>
                        <input type="text" class="amenity-name w-full border rounded p-2" value="${amenity?.amenity_name || ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select class="amenity-type w-full border rounded p-2">
                            <option value="comfort" ${amenity?.amenity_type === 'comfort' ? 'selected' : ''}>Comfort</option>
                            <option value="technology" ${amenity?.amenity_type === 'technology' ? 'selected' : ''}>Technology</option>
                            <option value="bathroom" ${amenity?.amenity_type === 'bathroom' ? 'selected' : ''}>Bathroom</option>
                            <option value="kitchen" ${amenity?.amenity_type === 'kitchen' ? 'selected' : ''}>Kitchen</option>
                            <option value="outdoor" ${amenity?.amenity_type === 'outdoor' ? 'selected' : ''}>Outdoor</option>
                            <option value="service" ${amenity?.amenity_type === 'service' ? 'selected' : ''}>Service</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Icon (FontAwesome)</label>
                        <input type="text" class="amenity-icon w-full border rounded p-2" value="${amenity?.icon || ''}" placeholder="fas fa-wifi">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" class="amenity-description w-full border rounded p-2" value="${amenity?.description || ''}">
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center mr-2">
                            <input type="checkbox" class="amenity-highlighted mr-1" ${amenity?.is_highlighted ? 'checked' : ''}>
                            <span class="text-sm">Highlight</span>
                        </label>
                        <button type="button" class="remove-amenity bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">Remove</button>
                    </div>
                `;
                
                amenitiesList.appendChild(row);

                // Add remove functionality
                row.querySelector('.remove-amenity').addEventListener('click', () => {
                    row.remove();
                });
            }

            async function saveAmenities(roomId) {
                const amenitiesList = document.getElementById('amenities-list');
                const amenityRows = amenitiesList.querySelectorAll('.grid');
                
                const amenities = Array.from(amenityRows).map(row => ({
                    amenity_name: row.querySelector('.amenity-name').value,
                    amenity_type: row.querySelector('.amenity-type').value,
                    icon: row.querySelector('.amenity-icon').value || null,
                    description: row.querySelector('.amenity-description').value || null,
                    is_highlighted: row.querySelector('.amenity-highlighted').checked
                })).filter(amenity => amenity.amenity_name.trim());

                try {
                    loading.show('Saving amenities...');
                    await dbAPI.updateRoomAmenities(roomId, amenities);
                    notify.success('Room amenities updated successfully');
                } catch (error) {
                    console.error('Error saving amenities:', error);
                    notify.error('Failed to save amenities: ' + error.message);
                } finally {
                    loading.hide();
                }
            }

            async function renderAccommodations() {
                try {
                    const response = await dbAPI.getAccommodations();
                    const accommodations = response.data || [];

                    accommodationContainer.innerHTML = '';
                    accommodations.forEach((accommodation) => {
                        const section = document.createElement('div');
                        section.className = 'bg-white p-6 rounded-lg shadow-md relative';
                        section.innerHTML = `
                            <h3 class="text-xl font-semibold mb-4">${accommodation.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label for="acc-image-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                                    <input type="text" id="acc-image-${accommodation.id}" value="${accommodation.image_url || ''}" class="w-full border rounded-md p-2 mb-4">
                                    ${accommodation.image_url ? `<img src="${accommodation.image_url}" class="max-w-xs rounded-md border" onerror="this.src='https://placehold.co/300x200/E0E0E0/666?text=Image+Not+Found'">` : ''}
                                </div>
                                <div>
                                    <label for="acc-name-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                    <input type="text" id="acc-name-${accommodation.id}" value="${accommodation.name}" class="w-full border rounded-md p-2 mb-4">
                                    
                                    <label for="acc-type-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select id="acc-type-${accommodation.id}" class="w-full border rounded-md p-2 mb-4">
                                        <option value="villa" ${accommodation.type === 'villa' ? 'selected' : ''}>Villa</option>
                                        <option value="room" ${accommodation.type === 'room' ? 'selected' : ''}>Room</option>
                                        <option value="suite" ${accommodation.type === 'suite' ? 'selected' : ''}>Suite</option>
                                    </select>
                                    
                                    <div class="grid grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label for="acc-guests-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Max Guests</label>
                                            <input type="number" id="acc-guests-${accommodation.id}" value="${accommodation.max_guests || ''}" class="w-full border rounded-md p-2">
                                        </div>
                                        <div>
                                            <label for="acc-bedrooms-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Bedrooms</label>
                                            <input type="number" id="acc-bedrooms-${accommodation.id}" value="${accommodation.bedrooms || ''}" class="w-full border rounded-md p-2">
                                        </div>
                                        <div>
                                            <label for="acc-bathrooms-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Bathrooms</label>
                                            <input type="number" id="acc-bathrooms-${accommodation.id}" value="${accommodation.bathrooms || ''}" class="w-full border rounded-md p-2">
                                        </div>
                                    </div>
                                    
                                    <label for="acc-price-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Price per Night</label>
                                    <input type="number" id="acc-price-${accommodation.id}" value="${accommodation.price_per_night || ''}" class="w-full border rounded-md p-2 mb-4" step="0.01">
                                    
                                    <label for="acc-desc-${accommodation.id}" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea id="acc-desc-${accommodation.id}" class="w-full border rounded-md p-2 h-24">${accommodation.description || ''}</textarea>
                                    
                                    <label for="acc-amenities-${accommodation.id}" class="block text-sm font-medium text-gray-700 mt-4 mb-1">Amenities (comma-separated)</label>
                                    <input type="text" id="acc-amenities-${accommodation.id}" value="${accommodation.amenities ? accommodation.amenities.join(', ') : ''}" class="w-full border rounded-md p-2">
                                    
                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="acc-active-${accommodation.id}" ${accommodation.is_active ? 'checked' : ''} class="mr-2">
                                            <span class="text-sm text-gray-700">Active</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button class="save-accommodation-btn bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" data-id="${accommodation.id}">Save Changes</button>
                                <button class="delete-accommodation-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" data-id="${accommodation.id}">Delete</button>
                            </div>
                        `;
                        accommodationContainer.appendChild(section);
                    });

                    // Add save event listeners
                    document.querySelectorAll('.save-accommodation-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const accommodationId = e.target.dataset.id;
                            try {
                                loading.show('Saving accommodation...');
                                const amenitiesText = document.getElementById(`acc-amenities-${accommodationId}`).value;
                                const amenities = amenitiesText ? amenitiesText.split(',').map(a => a.trim()).filter(a => a) : [];
                                
                                const accommodationData = {
                                    name: document.getElementById(`acc-name-${accommodationId}`).value,
                                    description: document.getElementById(`acc-desc-${accommodationId}`).value,
                                    type: document.getElementById(`acc-type-${accommodationId}`).value,
                                    max_guests: parseInt(document.getElementById(`acc-guests-${accommodationId}`).value) || null,
                                    bedrooms: parseInt(document.getElementById(`acc-bedrooms-${accommodationId}`).value) || null,
                                    bathrooms: parseInt(document.getElementById(`acc-bathrooms-${accommodationId}`).value) || null,
                                    price_per_night: parseFloat(document.getElementById(`acc-price-${accommodationId}`).value) || null,
                                    image_url: document.getElementById(`acc-image-${accommodationId}`).value,
                                    amenities: amenities,
                                    is_active: document.getElementById(`acc-active-${accommodationId}`).checked
                                };
                                
                                await dbAPI.updateAccommodation(accommodationId, accommodationData);
                                notify.success('Accommodation updated successfully');
                            } catch (error) {
                                console.error('Error saving accommodation:', error);
                                notify.error('Failed to save accommodation: ' + error.message);
                            } finally {
                                loading.hide();
                            }
                        });
                    });

                    // Add delete event listeners
                    document.querySelectorAll('.delete-accommodation-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const accommodationId = e.target.dataset.id;
                            if (confirm('Are you sure you want to delete this accommodation?')) {
                                try {
                                    loading.show('Deleting accommodation...');
                                    await dbAPI.deleteAccommodation(accommodationId);
                                    notify.success('Accommodation deleted successfully');
                                    await renderAccommodations();
                                } catch (error) {
                                    console.error('Error deleting accommodation:', error);
                                    notify.error('Failed to delete accommodation: ' + error.message);
                                } finally {
                                    loading.hide();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error loading accommodations:', error);
                    accommodationContainer.innerHTML = '<p class="text-red-500">Error loading accommodations. Please try again.</p>';
                }
            }

            async function renderButtons() {
                try {
                    const response = await dbAPI.getButtons();
                    const buttons = response.data || [];

                    buttonContainer.innerHTML = '';
                    buttons.forEach((button) => {
                        const section = document.createElement('div');
                        section.className = 'bg-white p-6 rounded-lg shadow-md';
                        section.innerHTML = `
                            <h3 class="text-xl font-semibold mb-4">${button.text}</h3>
                            <div>
                                <label for="btn-text-${button.id}" class="block text-sm font-medium text-gray-700 mb-1">Button Text</label>
                                <input type="text" id="btn-text-${button.id}" value="${button.text}" class="w-full border rounded-md p-2 mb-4">
                                
                                <label for="btn-url-${button.id}" class="block text-sm font-medium text-gray-700 mb-1">Button URL</label>
                                <input type="text" id="btn-url-${button.id}" value="${button.url || ''}" class="w-full border rounded-md p-2 mb-4">
                                
                                <label for="btn-style-${button.id}" class="block text-sm font-medium text-gray-700 mb-1">Button Style</label>
                                <select id="btn-style-${button.id}" class="w-full border rounded-md p-2 mb-4">
                                    <option value="primary" ${button.style === 'primary' ? 'selected' : ''}>Primary</option>
                                    <option value="secondary" ${button.style === 'secondary' ? 'selected' : ''}>Secondary</option>
                                    <option value="outline" ${button.style === 'outline' ? 'selected' : ''}>Outline</option>
                                </select>
                                
                                <label for="btn-icon-${button.id}" class="block text-sm font-medium text-gray-700 mb-1">Icon (FontAwesome class)</label>
                                <input type="text" id="btn-icon-${button.id}" value="${button.icon || ''}" class="w-full border rounded-md p-2 mb-4" placeholder="fas fa-home">
                                
                                <label for="btn-target-${button.id}" class="block text-sm font-medium text-gray-700 mb-1">Target</label>
                                <select id="btn-target-${button.id}" class="w-full border rounded-md p-2 mb-4">
                                    <option value="_self" ${button.target === '_self' ? 'selected' : ''}>Same Window</option>
                                    <option value="_blank" ${button.target === '_blank' ? 'selected' : ''}>New Window</option>
                                </select>
                                
                                <div class="mt-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="btn-active-${button.id}" ${button.is_active ? 'checked' : ''} class="mr-2">
                                        <span class="text-sm text-gray-700">Active</span>
                                    </label>
                                </div>
                                
                                <div class="mt-4 flex gap-2">
                                    <button class="save-button-btn bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" data-id="${button.id}">Save Changes</button>
                                    <button class="delete-button-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" data-id="${button.id}">Delete</button>
                                </div>
                            </div>
                        `;
                        buttonContainer.appendChild(section);
                    });

                    // Add save event listeners
                    document.querySelectorAll('.save-button-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const buttonId = e.target.dataset.id;
                            try {
                                loading.show('Saving button...');
                                const buttonData = {
                                    text: document.getElementById(`btn-text-${buttonId}`).value,
                                    url: document.getElementById(`btn-url-${buttonId}`).value,
                                    style: document.getElementById(`btn-style-${buttonId}`).value,
                                    icon: document.getElementById(`btn-icon-${buttonId}`).value,
                                    target: document.getElementById(`btn-target-${buttonId}`).value,
                                    is_active: document.getElementById(`btn-active-${buttonId}`).checked
                                };
                                
                                await dbAPI.updateButton(buttonId, buttonData);
                                notify.success('Button updated successfully');
                            } catch (error) {
                                console.error('Error saving button:', error);
                                notify.error('Failed to save button: ' + error.message);
                            } finally {
                                loading.hide();
                            }
                        });
                    });

                    // Add delete event listeners
                    document.querySelectorAll('.delete-button-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const buttonId = e.target.dataset.id;
                            if (confirm('Are you sure you want to delete this button?')) {
                                try {
                                    loading.show('Deleting button...');
                                    await dbAPI.deleteButton(buttonId);
                                    notify.success('Button deleted successfully');
                                    await renderButtons();
                                } catch (error) {
                                    console.error('Error deleting button:', error);
                                    notify.error('Failed to delete button: ' + error.message);
                                } finally {
                                    loading.hide();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error loading buttons:', error);
                    buttonContainer.innerHTML = '<p class="text-red-500">Error loading buttons. Please try again.</p>';
                }
            }

            async function renderPopup() {
                try {
                    const response = await dbAPI.getPopupItems();
                    const popupItems = response.data || [];
                    
                    // For now, just handle the first popup item
                    const popup = popupItems[0];
                    if (popup) {
                        document.getElementById('popup-title').value = popup.title || '';
                        document.getElementById('popup-message').value = popup.description || '';
                        document.getElementById('popup-image').value = popup.image_url || '';
                        document.getElementById('popup-button-text').value = popup.button_text || '';
                        document.getElementById('popup-button-link').value = popup.button_url || '';
                        updatePopupImagePreview();
                        
                        // Store popup ID for saving
                        document.getElementById('popup-title').dataset.popupId = popup.id;
                    }
                } catch (error) {
                    console.error('Error loading popup:', error);
                }
            }

            function updatePopupImagePreview() {
                const imageUrl = document.getElementById('popup-image').value;
                const previewDiv = document.getElementById('popup-image-preview');
                if (imageUrl.trim()) {
                    previewDiv.innerHTML = `<img src="${imageUrl}" class="max-w-xs rounded-md border" onerror="this.src='https://placehold.co/300x200/E0E0E0/666?text=Image+Not+Found'" alt="Popup Image Preview">`;
                } else {
                    previewDiv.innerHTML = '';
                }
            }

            async function renderParallax() {
                try {
                    const response = await dbAPI.getParallaxItems();
                    const parallaxItems = response.data || [];
                    
                    // For now, just handle the first parallax item
                    const parallax = parallaxItems[0];
                    if (parallax) {
                        document.getElementById('parallax-bg').value = parallax.image_url || '';
                        updateParallaxImagePreview();
                        
                        // Store parallax ID for saving
                        document.getElementById('parallax-bg').dataset.parallaxId = parallax.id;
                    }
                } catch (error) {
                    console.error('Error loading parallax:', error);
                }
            }

            function updateParallaxImagePreview() {
                const imageUrl = document.getElementById('parallax-bg').value;
                const previewDiv = document.getElementById('parallax-image-preview');
                if (imageUrl.trim()) {
                    previewDiv.innerHTML = `<img src="${imageUrl}" class="max-w-xs rounded-md border" onerror="this.src='https://placehold.co/300x200/E0E0E0/666?text=Image+Not+Found'" alt="Parallax Background Preview">`;
                } else {
                    previewDiv.innerHTML = '';
                }
            }

            async function renderPages() {
                try {
                    const response = await dbAPI.getPages();
                    const pages = response.data || [];

                    const pageContainer = document.getElementById('page-container');
                    pageContainer.innerHTML = '';
                    
                    pages.forEach((page) => {
                        const section = document.createElement('div');
                        section.className = 'bg-white p-6 rounded-lg shadow-md';
                        section.innerHTML = `
                            <h3 class="text-xl font-semibold mb-4">${page.title}</h3>
                            <div>
                                <label for="page-name-${page.id}" class="block text-sm font-medium text-gray-700 mb-1">Page Name</label>
                                <input type="text" id="page-name-${page.id}" value="${page.page_name}" class="w-full border rounded-md p-2 mb-4">
                                
                                <label for="page-title-${page.id}" class="block text-sm font-medium text-gray-700 mb-1">Page Title</label>
                                <input type="text" id="page-title-${page.id}" value="${page.title}" class="w-full border rounded-md p-2 mb-4">
                                
                                <label for="page-desc-${page.id}" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea id="page-desc-${page.id}" class="w-full border rounded-md p-2 h-24 mb-4">${page.description || ''}</textarea>
                                
                                <label for="page-meta-${page.id}" class="block text-sm font-medium text-gray-700 mb-1">Meta Description</label>
                                <textarea id="page-meta-${page.id}" class="w-full border rounded-md p-2 h-20 mb-4">${page.meta_description || ''}</textarea>
                                
                                <label for="page-keywords-${page.id}" class="block text-sm font-medium text-gray-700 mb-1">Keywords (comma-separated)</label>
                                <input type="text" id="page-keywords-${page.id}" value="${page.keywords ? page.keywords.join(', ') : ''}" class="w-full border rounded-md p-2 mb-4">
                                
                                <div class="mt-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="page-active-${page.id}" ${page.is_active ? 'checked' : ''} class="mr-2">
                                        <span class="text-sm text-gray-700">Active</span>
                                    </label>
                                </div>
                                
                                <div class="mt-4 flex gap-2">
                                    <button class="save-page-btn bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600" data-id="${page.id}">Save Changes</button>
                                    <button class="delete-page-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" data-id="${page.id}">Delete</button>
                                </div>
                            </div>
                        `;
                        pageContainer.appendChild(section);
                    });

                    // Add save event listeners
                    document.querySelectorAll('.save-page-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const pageId = e.target.dataset.id;
                            try {
                                loading.show('Saving page...');
                                const keywordsText = document.getElementById(`page-keywords-${pageId}`).value;
                                const keywords = keywordsText ? keywordsText.split(',').map(k => k.trim()).filter(k => k) : [];
                                
                                const pageData = {
                                    page_name: document.getElementById(`page-name-${pageId}`).value,
                                    title: document.getElementById(`page-title-${pageId}`).value,
                                    description: document.getElementById(`page-desc-${pageId}`).value,
                                    meta_description: document.getElementById(`page-meta-${pageId}`).value,
                                    keywords: keywords,
                                    is_active: document.getElementById(`page-active-${pageId}`).checked
                                };
                                
                                await dbAPI.updatePage(pageId, pageData);
                                notify.success('Page updated successfully');
                            } catch (error) {
                                console.error('Error saving page:', error);
                                notify.error('Failed to save page: ' + error.message);
                            } finally {
                                loading.hide();
                            }
                        });
                    });

                    // Add delete event listeners
                    document.querySelectorAll('.delete-page-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const pageId = e.target.dataset.id;
                            if (confirm('Are you sure you want to delete this page?')) {
                                try {
                                    loading.show('Deleting page...');
                                    await dbAPI.deletePage(pageId);
                                    notify.success('Page deleted successfully');
                                    await renderPages();
                                } catch (error) {
                                    console.error('Error deleting page:', error);
                                    notify.error('Failed to delete page: ' + error.message);
                                } finally {
                                    loading.hide();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error loading pages:', error);
                    document.getElementById('page-container').innerHTML = '<p class="text-red-500">Error loading pages. Please try again.</p>';
                }
            }

            addImageBtn.addEventListener('click', async () => {
                try {
                    loading.show('Creating new image...');
                    const newImageData = {
                        src: "https://placehold.co/400x300/FFFFFF/E0E0E0?text=New+Image",
                        alt: "New Image",
                        type: "gallery",
                        category: "general"
                    };
                    
                    await dbAPI.createImage(newImageData);
                    notify.success('New image created successfully');
                    await renderImages();
                } catch (error) {
                    console.error('Error creating image:', error);
                    notify.error('Failed to create image: ' + error.message);
                } finally {
                    loading.hide();
                }
            });

            addRoomTypeBtn.addEventListener('click', async () => {
                try {
                    loading.show('Creating new room type...');
                    const newRoomTypeData = {
                        name: "New Room Type",
                        description: "Description for the new room type",
                        base_price: 100.00,
                        max_guests: 2,
                        size_sqm: 25,
                        is_active: true,
                        sort_order: 0
                    };
                    
                    await dbAPI.createRoomType(newRoomTypeData);
                    notify.success('New room type created successfully');
                    await renderRoomTypes();
                    await renderRooms(); // Refresh rooms dropdown
                } catch (error) {
                    console.error('Error creating room type:', error);
                    notify.error('Failed to create room type: ' + error.message);
                } finally {
                    loading.hide();
                }
            });

            addRoomBtn.addEventListener('click', async () => {
                try {
                    // Get room types for validation
                    const roomTypesResponse = await dbAPI.getRoomTypes();
                    const roomTypes = roomTypesResponse.data || [];
                    
                    if (roomTypes.length === 0) {
                        notify.warning('Please create at least one room type first');
                        return;
                    }

                    loading.show('Creating new room...');
                    const newRoomData = {
                        room_number: `R${Date.now().toString().slice(-3)}`,
                        room_type_id: roomTypes[0].id,
                        name: "New Room",
                        description: "Description for the new room",
                        price_per_night: 120.00,
                        max_guests: 2,
                        bedrooms: 1,
                        bathrooms: 1,
                        view_type: "garden",
                        status: "available",
                        is_active: true
                    };
                    
                    await dbAPI.createRoom(newRoomData);
                    notify.success('New room created successfully');
                    await renderRooms();
                } catch (error) {
                    console.error('Error creating room:', error);
                    notify.error('Failed to create room: ' + error.message);
                } finally {
                    loading.hide();
                }
            });

            addAccommodationBtn.addEventListener('click', async () => {
                try {
                    loading.show('Creating new accommodation...');
                    const newAccommodationData = {
                        name: "New Accommodation",
                        description: "A description for the new accommodation.",
                        type: "villa",
                        max_guests: 2,
                        bedrooms: 1,
                        bathrooms: 1,
                        price_per_night: 100.00,
                        image_url: "https://placehold.co/600x400/FFFFFF/E0E0E0?text=New+Accommodation",
                        amenities: ["WiFi", "Air Conditioning"],
                        is_active: true
                    };
                    
                    await dbAPI.createAccommodation(newAccommodationData);
                    notify.success('New accommodation created successfully');
                    await renderAccommodations();
                } catch (error) {
                    console.error('Error creating accommodation:', error);
                    notify.error('Failed to create accommodation: ' + error.message);
                } finally {
                    loading.hide();
                }
            });

            saveAllBtn.addEventListener('click', async () => {
                try {
                    loading.show('Saving global settings...');
                    let saveCount = 0;
                    
                    // Save popup if it exists
                    const popupTitleElement = document.getElementById('popup-title');
                    if (popupTitleElement && popupTitleElement.dataset.popupId) {
                        const popupData = {
                            title: document.getElementById('popup-title').value,
                            description: document.getElementById('popup-message').value,
                            image_url: document.getElementById('popup-image').value,
                            button_text: document.getElementById('popup-button-text').value,
                            button_url: document.getElementById('popup-button-link').value
                        };
                        
                        await dbAPI.updatePopupItem(popupTitleElement.dataset.popupId, popupData);
                        saveCount++;
                    }

                    // Save parallax if it exists
                    const parallaxBgElement = document.getElementById('parallax-bg');
                    if (parallaxBgElement && parallaxBgElement.dataset.parallaxId) {
                        const parallaxData = {
                            image_url: parallaxBgElement.value
                        };
                        
                        await dbAPI.updateParallaxItem(parallaxBgElement.dataset.parallaxId, parallaxData);
                        saveCount++;
                    }

                    if (saveCount > 0) {
                        notify.success(`Successfully saved ${saveCount} global setting(s)`);
                        saveMessage.textContent = `Global settings saved to database! (${saveCount} items)`;
                        saveMessage.className = 'text-sm mt-4 text-green-500';
                    } else {
                        notify.info('No global settings to save');
                        saveMessage.textContent = 'No changes to save for global settings.';
                        saveMessage.className = 'text-sm mt-4 text-blue-500';
                    }
                } catch (error) {
                    console.error('Error saving global settings:', error);
                    notify.error('Failed to save global settings: ' + error.message);
                    saveMessage.textContent = 'Error saving global settings!';
                    saveMessage.className = 'text-sm mt-4 text-red-500';
                } finally {
                    loading.hide();
                }
            });

            // Add logout functionality
            document.querySelector('a[href="login.html"]').addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });

            // Auto-logout on session timeout
            setInterval(() => {
                if (!checkAuthentication()) {
                    alert('Session expired. Please login again.');
                }
            }, 60000); // Check every minute

            fetchContent();
        });

        // Logout function
        async function logout() {
            try {
                await fetch('/api/auth.php', { method: 'DELETE' });
            } catch (error) {
                console.error('Logout failed:', error);
            } finally {
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
