<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Image Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">Manage Website Images</h1>
        <div id="image-management-container" class="space-y-8">
            <!-- Image sections will be dynamically added here -->
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('image-management-container');

            async function fetchImages() {
                try {
                    const response = await fetch('/api/images');
                    const result = await response.json();
                    if (result.success) {
                        return result.images;
                    } else {
                        console.error('Failed to fetch images:', result.error);
                        return [];
                    }
                } catch (error) {
                    console.error('Error fetching images:', error);
                    return [];
                }
            }

            const images = await fetchImages();

            images.forEach(imageName => {
                const imageSrc = `images/${imageName}`;
                const section = document.createElement('div');
                section.className = 'bg-white p-6 rounded-lg shadow-md';
                section.innerHTML = `
                    <h2 class="text-xl font-semibold mb-4">${imageSrc}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div>
                            <p class="mb-2 font-medium">Current Image:</p>
                            <img src="${imageSrc}" alt="${imageSrc}" class="max-w-xs rounded-md border">
                        </div>
                        <div>
                            <p class="mb-2 font-medium">Upload New Image:</p>
                            <input type="file" id="file-input-${imageSrc.replace(/[^a-zA-Z0-9]/g, '-')}" class="w-full border rounded-md p-2">
                            <button class="save-btn mt-4 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700" data-src="${imageSrc}">Save</button>
                            <p class="message text-sm mt-2"></p>
                        </div>
                    </div>
                `;
                container.appendChild(section);
            });

            container.addEventListener('click', async (e) => {
                if (e.target.classList.contains('save-btn')) {
                    const imageSrc = e.target.dataset.src;
                    const fileInput = document.getElementById(`file-input-${imageSrc.replace(/[^a-zA-Z0-9]/g, '-')}`);
                    const file = fileInput.files[0];
                    const messageEl = e.target.nextElementSibling;

                    if (!file) {
                        messageEl.textContent = 'Please select a file.';
                        messageEl.className = 'message text-sm mt-2 text-red-500';
                        return;
                    }

                    const formData = new FormData();
                    // We need to create a new File object with the correct name, so it overwrites the original.
                    const newFile = new File([file], imageSrc.split('/').pop(), { type: file.type });
                    formData.append('image', newFile);

                    try {
                        messageEl.textContent = 'Uploading...';
                        messageEl.className = 'message text-sm mt-2 text-gray-500';

                        const response = await fetch('/api/upload-image', {
                            method: 'POST',
                            body: formData,
                        });

                        const result = await response.json();

                        if (result.success) {
                            messageEl.textContent = 'Upload successful! The image has been updated.';
                            messageEl.className = 'message text-sm mt-2 text-green-500';
                            // Update the preview image
                            const img = e.target.closest('.grid').querySelector('img');
                            img.src = `${imageSrc}?t=${new Date().getTime()}`; // Add a timestamp to break the cache
                        } else {
                            messageEl.textContent = `Error: ${result.error}`;
                            messageEl.className = 'message text-sm mt-2 text-red-500';
                        }
                    } catch (error) {
                        messageEl.textContent = 'An unexpected error occurred.';
                        messageEl.className = 'message text-sm mt-2 text-red-500';
                    }
                }
            });
        });
    </script>
</body>
</html>
